---
title: 年中总结
categories:
  - 想法流水
tags:
  - 想法流水
comments: false
abbrlink: 438
date: 2021-05-04 10:25:00
img:
---

## 前言

这半年很充实，但有点累。有点累，但很充实。🤭

回顾一下工作之 ~~YU~~ ，做了一些事儿

## 迭代开源框架

去年我开源了一个框架项目：EasyGameFramework:https://gitee.com/AIGAMESTUDIO.AILHC/EasyGameFrameworkOpen

随着不断的迭代，感觉它慢慢的变得更加强大，心中甚是喜悦。如果感兴趣可以look look，如果觉得不错可以点个小星星★

最近也在想着改名，改一个更加合适的名字。之前想的是金箍棒~

![](https://cdn.jsdelivr.net/gh/ailhc/picture/img/金箍棒动画.gif)


先讲一下最近更新的

### 臻于完美的模块构建工具

我的初衷是做一个可以直接一键将`功能模块`打包成`拥有不同模块规范的npm包`，给不同的项目使用。

不用进行繁琐的配置。

因为这样方便进行模块级别的版本管理，不同的H5游戏引擎都可以轻松使用，达到跨项目，跨引擎的功能模块复用的目的。

一开始，只是能打包成js和单个d.ts声明文件，小问题挺多的，在后续的迭代中，改进了很多。

比如：

* vscode的自动导入识别错误（让人脑阔疼）
* CocosCreator3的ESM模块和CocosCreator2.x的Commonjs模块共存
* 自动/手动生成index.ts
* 完善扩展性（在开箱即用的情况下，又能进行自定义）

#### 其他项目实践

1. 通过开发cocosCreator的Typescript插件模板，让这个工具的扩展性变得更加强大，支持插件项目的编译和构建，打破玄学。

2. 后来通过尝试构建输出CocosCreator3的 farygui 库，也有了打包大型框架库的实践。

#### 后续的计划

加入开发时的esbuild支持：更快，更强。

### 实现了display-ctrl的fairygui版本

谷主发布了fairygui的CocosCreator3.0的适配：https://forum.cocos.org/t/topic/112136/5

而我抽空实现一下display-ctrl的fairygui实现:`dpctrl-fgui`

因为fairygui实现了不同引擎的适配嘛，所以这个模块不需要做太多也可以兼容不同引擎。（ps:就试了Laya和Cocos）

不需要做太多兼容，但还是要做的。。。因为Laya的实现和Cocos的实现中有微小的不同。。。

```ts
//fgui-layer.ts
...
onSpAdd(sp: any): void {
        const fgo = new fairygui.GObject();
        //兼容cc/laya
        fgo["_displayObject"] = sp;//Laya中的实现
        fgo["_node"] = sp;//Cocos中的实现
        //兼容cc/laya
        sp["$owner"] = fgo;//Laya中的实现
        sp["$gobj"] = fgo;//Cocos中的实现
        this.addChild(fgo);
    }
...
//fix-some-fgui.ts
Object.defineProperty(fairygui.GObject.prototype, "displayObject", {
    get: function () {
        return this._node;
    },
    enumerable: false,
    configurable: true
});
```



我更新了示例，感兴趣的可以看看

示例:http://aigamestudio.ailhc.gitee.io/easygameframeworkopen/examples/egf-ccc-full/

![](https://cdn.jsdelivr.net/gh/ailhc/picture/img/fairygui-demo.gif)


我现在的公司项目是Laya+Fgui，算是深度使用Fgui了。

FairyGUI非常好用。

但如果有大量的包，而且不同包之间的有资源引用，Fgui官方的使用方式会是一种噩梦。而如果你要进行精确的资源内存管理的话，更是噩梦中的噩梦。

对于这种情况，我这边是写一个插件和配套的运行时，插件导出资源引用信息，提高开发和内存管理的效率。

### 完善通用对象池模块

对象池是游戏开发中非常常用的一种模式，用于减少对象的频繁创建和销毁导致的性能压力。

Cocos中也有对象池模块:`NodePool`,Laya中也有一个全局的对象池模块`Laya.Pool`

这两个都有深入使用过。它们功能非常简单，在使用过程中往往需要加上自己的一些封装，或者是到处写一些重复的代码。

为了在不同的项目中重复造轮子，于是造了这个好用的对象池模块。

**前段时间完善了它的类型提示，使用更加舒适。**

并且增加了阈值控制系统，缓存数超过阈值就销毁，让池子不再无限暴涨

可以简单感受一下:

```ts
//使用全局管理器
const mgr = new ObjPoolMgr();
//实现对象池接口
class ClassA implements objPool.IObj{
    onGet(){

    }
    onReturn(){

    }
    onKill(){

    }
}
mgr.createObjPool({sign:"test1",clas:ClassA});
const ins1 = mgr.get("test1");

//注入通用对象处理函数
//这样对于没有实现IObj接口的对象也可以
const objPool = new BaseObjPool();

objPool.init(
    {
        sign: "pool1",
        objHandler: {
            onGet(obj: objPool.IObj, onGetData: any) {

            },
            onCreate(obj): void {

            },
            onReturn(obj): void {

            },
            onKill(obj): void {

            }

        }
    }
)
```
1. 提示更加智能

```ts
interface ITestObjGetDataMap {
    TestObj1: { num: number },
    TestObj2: { name: string },
    TestObj3: { name: string }
}
const poolMgr = new ObjPoolMgr<ITestObjGetDataMap>();
poolMgr.createByClass("TestObj1", TestObj1);
poolMgr.createByFunc("TestObj2", () => {
    return new TestObj2();
});
poolMgr.preCreate("TestObj1", 5);
//get 这里get可以获得对应"TestObj1"的传参类型提示
const testObj1: TestObj1 = poolMgr.get("TestObj1", { num: 2 });

//批量获取
const testObj2s: TestObj2[] = poolMgr.getMore("TestObj2", { name: "testObj2" }, 4);

```

3. 阈值控制

```ts
const objPool = new BaseObjPool();

objPool.init(
    {
        sign: "pool1",
        objHandler: {
            onGet(obj: objPool.IObj, onGetData: any) {

            },
            onCreate(obj): void {

            },
            onReturn(obj): void {

            },
            onKill(obj): void {

            }

        },
        //阈值
        threshold: 100
    }
)
//回收对象，如果对象池里的数量大于等于100，则这个obj就会被kill掉（销毁）;
objPool.return(obj);
```

再Q一下更早之前更新的

### 整了一个通用网络模块`enet`

一个不受限于引擎和框架，易于使用并且能够扩展不同的底层以及上层显示的网络模块。

我做过几个项目，有用nodejs做后端的，有用nodejs的pomelo框架做后端的，有erlang做后端的，有用java的，使用的协议，网络交互底层都不太一样。

我都得去适配，去写一个网络模块。如果以后，还会遇到不同的后端，那我不太愿意再去重写一个网络模块了。我想用一个就够了。

过完年后，我花了一段时间，去整理提炼我之前项目写过的网络模块。

将它设计成一个，底层无关，业务无关的网络模块，并提供三层可扩展接口：显示层，协议层，socket层

并且实现了常见的网络交互组合：`pomelo`、`websocket+protobuf`、`websocket`

只要有需要就可以轻松替换不同的层，但面向业务的接口始终不变。

这是我写的一篇文章，可以了解一下：

一起聊天吃瓜放烟花:https://mp.weixin.qq.com/s/tzGzHhPYoIL10skjmuyO_Q

### 为了更方便使用protobuf

之前我基于白鹭引擎组写的一个protobuf命令工具，写了一个适用于任意引擎的版本（给自己的Laya项目用）。

不满足于能用，为了更加方便，我重写了它。于是就有了`egf-protobuf-cli`

**它的特性**

1. 提供 protobuf.js 基础运行时库
2. 提供命令行脚本，将 protofile 生成 JavaScript 代码
3. 生成正确的 .d.ts 代码，以方便 TypeScript 项目使用
5. 理论上支持所有 HTML5 游戏引擎。欢迎使用 PIXI.js , Cocos2d-js , LayaAir 等其他引擎的开发者使用本库。
6. 封装protobufjs的命令行，不需另外安装protobufjs
7. 支持服务端文件同时输出
8. 配置有智能提示

直接npm安装使用

```bash
npm install egf-protobuf -g
```
具体可见:http://aigamestudio.ailhc.gitee.io/easygameframeworkopen/#/packages/egf-protobuf-cli/README



## 整工具

### 可能有点香的解决方案

很多人吐槽CocosCreator2.x资源多的时候卡顿，打开慢的问题。

原因可能大家都知道：编辑器会监听 assets 文件夹内的文件变动，并会做一些处理

其实我在想，其实很多资源其实没有必要放在assets目录，比如道具武器的icon资源、大量的序列帧图集等

我也相信CocosCreator肯定可以解析实例化外部资源(龙骨、tiledmap、图集、图片等)

所以我做了一个尝试:
具体可见:https://mp.weixin.qq.com/s/t7664GuXvEWz2BKnbpPDCw

测试视频:https://www.bilibili.com/video/BV1WU4y1b7Es/

最近增加了解析tiledmap资源逻辑
![](https://cdn.jsdelivr.net/gh/ailhc/picture/img/big-template-tiledmap-android-demo.gif)

打包原生测试通过，相关工具快搞好了~

可以稍稍期待一下😋

### 整一个相对好用的导表工具

一开始我项目的导表工具是拿网上的来魔改，并且加上导出erlang用的文件的功能。

后来到了新的项目组，重写了一次，因为表格规范不一样，期间还迭代了两次

1. 要加表头
2. 表格文件多，导表速度慢了，增加增量导出功能

这一次是第三代了，一个更加强大、相对之前更加好用的一代。

它首先解决的问题是：根据项目需求自由扩展和自定义

1. 支持多线程（表格文件越多，效果越好）
2. 新的架构带来更强的自定义功能：自定义格式解析、自定义文件转换、自定义导出流程(比如：导出自动后上传ftp、提交svn)
   
我不想再写一次了。。。



### 顺便写了个typescript插件模板

当时想开发CocosCreator插件，但是上手有丢丢麻烦。社区论坛有一些问题的答案和教程，但还是不爽。

为什么，就要一直玄学？就要用不完全又繁琐的typescript开发方式？

**工欲善其事必先利其器**

虽然插件我现在还没做完。。。因为去捣鼓别的去了

来个视频感受一下

https://www.bilibili.com/video/BV1Ny4y1b7Vh






## 最后

如果对游戏开发感兴趣的，想了解更多游戏开发相关的事和知识

可以关注公众号或者加群交流

公众号搜索:玩转游戏开发


或扫码:<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abd0c14c9c954e56af20adb71fa00da9~tplv-k3u1fbpfcp-zoom-1.image" alt="img" style="zoom:50%;" />



QQ 群: 1103157878



博客主页: https://ailhc.github.io/



掘金: https://juejin.cn/user/3069492195769469



github: https://github.com/AILHC