---
title: ä¸€èµ·èŠå¤©åƒç“œæ”¾çƒŸèŠ±-ä»¿å¾®ä¿¡èŠå¤©æ”¾çƒŸèŠ±æ•ˆæœ
categories:
  - EasyGameFramework
  - æƒ³æ³•æµæ°´
tags:
  - EasyGameFramework
  - Discussion
  - enet
comments: false
abbrlink: 48570
date: 2021-01-17 21:29:02
img:
---
## æ‰“ä¸ªæ‹›å‘¼

å¤§å®¶å¥½~

**æ¸¸æˆå¼€å‘ä¹‹è·¯æœ‰è¶£ä½†ä¸æ˜“,**

**ç©èµ·æ¥æ‰èƒ½ä¸€ç›´çƒ­æƒ…æ´‹æº¢ã€‚**

æˆ‘æ˜¯å–œæ¬¢**æ¸¸æˆå¼€å‘**çš„æµ·æ½®ğŸ˜‰

## å‰è¨€

**ç¤¾äº¤**æ˜¯äººçš„åŸºæœ¬éœ€æ±‚ã€‚

äº’è”ç½‘æ—¶ä»£ï¼ŒåŸºäºäº’è”ç½‘çš„ç¤¾äº¤å¸¦ç»™ç½‘æ°‘ä»¬æ— ç©·çš„æ¬¢ä¹å’Œ**ç“œ**ã€‚
<img src="https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/chigua.jpg" alt="åƒç“œ" style="zoom:50%;" />

é‚£äº›èƒ½å¤Ÿå®æ—¶äº¤äº’çš„ç¤¾äº¤è½¯ä»¶/æ¸¸æˆï¼Œå¾€å¾€ä¼šå¸¦ç»™æˆ‘ä»¬æ›´å¤šæƒŠå–œã€‚

æœ€è¿‘å¾®ä¿¡æ›´æ–°äº†8.0ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨èŠå¤©çš„æ—¶å€™æ”¾ç‚¸å¼¹ï¼ŒçƒŸèŠ±ç­‰åŠ¨æ€è¡¨æƒ…ã€‚å¾ˆå¤šäººéƒ½ç©å¾—ä¸äº¦ä¹ä¹~

åœ¨è¿™ä¹‹å‰å‘¢ï¼Œæˆ‘çš„æ¡†æ¶ä»“åº“å¢åŠ äº†ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œæ¨¡å—ï¼Œå¯ä»¥ç”¨äºæ„å»ºé•¿è¿æ¥ç½‘ç»œæ¸¸æˆ/åº”ç”¨ã€‚

ç‰¹æ€§:
1. è·¨å¹³å°:é€‚ç”¨äºä»»æ„ts/jsé¡¹ç›®
2. çµæ´»ã€é«˜å¯æ‰©å±•:å¯ä»¥æ ¹æ®é¡¹ç›®éœ€è¦è¿›è¡Œå¤šå±‚æ¬¡å®šåˆ¶
3. é›¶ä¾èµ–
4. å¼ºç±»å‹:åŸºäºTypeScript
5. åŠŸèƒ½å¼ºå¤§:æä¾›å®Œæ•´çš„åŸºæœ¬éœ€æ±‚å®ç°(æ¶ˆæ¯å¤„ç†ã€æ¡æ‰‹ã€å¿ƒè·³ã€é‡è¿)
6. å¯é :å®Œå–„çš„å•å…ƒæµ‹è¯•

ä¼ é€é—¨:[enet](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/enet#readme)

é‚£æ¥ä¸‹æ¥ï¼Œæˆ‘å¸¦å¤§å®¶å€ŸåŠ©enetåº“å®ç°

1. ä¸€ä¸ªå¸¦çƒŸèŠ±æ•ˆæœçš„socket demo(è¶…ç®€å•ï¼Œä¸‰æ­¥å°±å¯ä»¥)
   
2. ä¸€ä¸ªæ¥è¿‘çœŸå®ç½‘ç»œæ¸¸æˆå¼€å‘çš„å¤šäººèŠå¤©å®¤demo
   

ç©èµ·æ¥~

## æç®€èŠå¤©æ”¾çƒŸèŠ±

### ç¬¬ä¸€æ­¥:å¼•å…¥ç½‘ç»œåº“å¹¶åˆå§‹åŒ–

enetè¿™ä¸ªåº“ï¼Œå‘å¸ƒäºnpmå…¬å…±ä»“åº“ä¸­ã€‚æä¾›å¤šç§è§„èŒƒï¼Œé€‚ç”¨äºä»»ä½•å¹³å°ã€‚

è¿™æ¬¡æˆ‘ä»¬ç›´æ¥é€šè¿‡urlå¼•å…¥iifeæ ¼å¼çš„js

1. åˆ›å»ºhtmlæ–‡ä»¶,å¼•å…¥enetåº“
```html

<!DOCTYPE html>
<html>

<div id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/@ailhc/enet@1.0.0/dist/iife/lib/index.js"></script>

</body>

</html>

```
2. åˆå§‹åŒ–enet

```html
<script>
    var netNode = new enet.NetNode();
    //å®šåˆ¶ç½‘ç»œäº‹ä»¶åé¦ˆé€»è¾‘
    netNode.init({
        netEventHandler: {
            //å¼€å§‹è¿æ¥äº‹ä»¶
            onStartConnenct: () => {
                console.log(`å¼€å§‹è¿æ¥æœåŠ¡å™¨`);
            },
            //è¿æ¥æˆåŠŸäº‹ä»¶
            onConnectEnd: () => {
                console.log(`è¿æ¥æœåŠ¡å™¨æˆåŠŸğŸ‘Œ`);
            }
        }
    });
    
</script>
```
### ç¬¬äºŒæ­¥: å†™ä¸Šæ”¶å‘æ¶ˆæ¯çš„é€»è¾‘
å°±å‡ å¥ä»£ç ï¼Œso easy~
```html
<script>
    //çœç•¥åˆå§‹åŒ–é€»è¾‘..
    //è¿ä¸Šä¸€ä¸ªå…¬ç”¨çš„websocketæµ‹è¯•æœåŠ¡å™¨,å®ƒä¼šåŸæœ¬ä¸åŠ¨çš„è¿”å›å‘å‡ºçš„æ¶ˆæ¯
    netNode.connect("wss://echo.websocket.org/");

    window.netNode = netNode;
    //å°è£…å‘é€æ¶ˆæ¯é€»è¾‘ï¼Œç›¸å½“äºå¾®ä¿¡å‘é€æŒ‰é’®
    window.sendMsgToServer = function (msg) {
        if (!netNode.socket.isConnected) {
            console.warn(`æœåŠ¡å™¨è¿˜æ²¡è¿ä¸Š`);
            return;
        }
        netNode.notify("msg", msg);
    }
    //ç›‘å¬æœåŠ¡å™¨æ¶ˆæ¯è¿”å›
    netNode.onPush("msg", function (dpkg) {
        console.log(`æœåŠ¡å™¨è¿”å›:`, dpkg.data);
    })
    
</script>
```
è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œçœ‹çœ‹æ•ˆæœäº†
ç­‰å¾…æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ˆå› ä¸ºé‚£ä¸ªå…¬ç”¨çš„æµ‹è¯•æœåŠ¡å™¨æœ‰æ—¶æ…¢æœ‰æ—¶å¿«ï¼‰

åœ¨æ§åˆ¶å°è¾“å…¥ sendMsgToServer("hello enet")

![img](https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/html-enet-test1.gif)

### ç¬¬ä¸‰æ­¥:åŠ ä¸ŠçƒŸèŠ±æ•ˆæœ

çƒŸèŠ±æ•ˆæœç½‘ä¸Šæ‰’æ¥çš„
[å¿«è¿‡å¹´äº†ï¼Œç”¨JSè®©ä½ çš„ç½‘é¡µæ”¾çƒŸèŠ±å§](https://blog.csdn.net/weixin_42686892/article/details/112589511)

åœ¨åŸæ¥çš„ä»£ç é‡Œæ”¹
```html
<script>
  //çœç•¥
    window.sendMsgToServer = function (msg) {
        /**çœç•¥*/
        checkAndFire(msg, true);
    }
    netNode.onPush("msg", function (dpkg) {
        console.log(`æœåŠ¡å™¨è¿”å›:`, dpkg.data);
        checkAndFire(dpkg.data, false);
    })

    function checkAndFire(msg, left) {
        if (msg.includes("çƒŸèŠ±") | msg.includes("ğŸ‡")) {
            fire(window.innerWidth * (left ? 1 / 3 : 2 / 3), window.innerHeight / 2);
        }
    }
</script>
```
è¿è¡Œèµ·æ¥ï¼Œçœ‹çœ‹æ•ˆæœ

![img](https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/html-enet-test2.gif)

ç®€å•çš„ä»¿å¾®ä¿¡èŠå¤©æ”¾çƒŸèŠ±å°±è¿™æ ·äº†

[åœ¨çº¿demo](https://ailhc.github.io/demos/enet-simple-demo/index.html)

[æºç ](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/examples/egf-net-ws/egf-simple-net-client)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æä¸ªå¤§çš„ã€‚

## å¤šäººèŠå¤©æ”¾çƒŸèŠ±

åœ¨å®é™…çš„ç½‘ç»œåº”ç”¨å¼€å‘ä¸­ï¼Œç½‘ç»œé€šä¿¡çš„éœ€æ±‚ä¼šå¤æ‚è®¸å¤šã€‚

1. å¯èƒ½ä¼šä½¿ç”¨åè®®åŒ…è£…é€šä¿¡æ•°æ®è¿›è¡Œä¼ è¾“
2. å¯èƒ½ä¼šå¯¹é€šä¿¡æ•°æ®è¿›è¡ŒåŠ å¯†
3. å¯èƒ½ä¼šä½¿ç”¨ç‰¹æ®Šçš„socket(socket.io)ï¼Œç”šè‡³å®šåˆ¶socket
4. å¿ƒè·³å¤„ç†
5. æ¡æ‰‹å¤„ç†
6. æ–­çº¿é‡è¿å¤„ç†

**enet**æ¨¡å—å¯¹ä¸Šè¿°æƒ…å†µéƒ½è¿›è¡Œäº†å°è£…ï¼Œåªéœ€è¦æ ¹æ®æä¾›çš„æ¥å£è¿›è¡Œå®ç°å°±å¯(æ— éœ€æ”¹æºç )

åœ¨è¿™ä¸ªå¤šäººèŠå¤©å®¤demoä¸­ï¼Œæˆ‘å°†ä½¿ç”¨**protobuf**ä½œä¸ºé€šä¿¡åè®®ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨protobufï¼Ÿ

**ä»€ä¹ˆæ˜¯protobuf**

   > protobuf(Google Protocol Buffers)æ˜¯Googleæä¾›ä¸€ä¸ªå…·æœ‰é«˜æ•ˆçš„åè®®æ•°æ®äº¤æ¢æ ¼å¼å·¥å…·åº“(ç±»ä¼¼Json)ï¼Œä½†ç›¸æ¯”äºJsonï¼ŒProtobufæœ‰æ›´é«˜çš„è½¬åŒ–æ•ˆç‡ï¼Œæ—¶é—´æ•ˆç‡å’Œç©ºé—´æ•ˆç‡éƒ½æ˜¯JSONçš„3-5å€ã€‚

   > protobufæä¾›äº†å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ”¯æŒï¼šC++ï¼ŒJAVAï¼ŒPythonï¼ŒC#ï¼Œerlangç­‰

**ä¼˜åŠ¿**
* å¯ä»¥å¿«é€Ÿç©èµ·æ¥ï¼Œç»Ÿä¸€çš„åè®®è¯­è¨€å¯ä»¥å’Œå¤šç§åç«¯è¯­è¨€å¿«ä¹åœ°ç©èµ·æ¥ï¼Œç”šè‡³å¤šäººsportğŸ¤ªğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ§‘ğŸ¿ğŸ‘¬ğŸ‘¨ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ¼

* ä¸ç”¨è‡ªå·±è®¾è®¡åè®®å’Œå®ç°åè®®ç¼–è§£ç 

ğŸ‘€æ¥çœ‹çœ‹å¦‚ä½•æ¥å…¥**protobuf**

### ä½¿ç”¨protobuf

è™½ç„¶ä¸ç”¨è‡ªå·±è®¾è®¡åè®®ï¼Œä½†æ€ä¹ˆæ¥å…¥å¼€å‘ä¸­è¿˜æ˜¯éœ€è¦æ»´

**å¸¸è§çš„protobufä½¿ç”¨æ–¹å¼**

1. ä½¿ç”¨protobufjsåº“åŠ è½½protoæ–‡ä»¶ï¼Œç„¶åè¿›è¡Œåè®®ç¼–ç è§£ç 
2. ä½¿ç”¨protobufå·¥å…·å°†protoæ–‡ä»¶è½¬æˆjsæ–‡ä»¶+.d.tså£°æ˜æ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ä¸­åŒæ—¶å¼•å…¥protobufåº“å’Œå¯¼å‡ºçš„jsæ–‡ä»¶å°±å¯

æˆ‘è¿™é‡Œé€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆ
* ä¼˜ç‚¹:ä½¿ç”¨æ–¹ä¾¿ï¼Œé€‚ç”¨äºå¤šç§ç¯å¢ƒï¼Œæœ‰ç±»å‹å£°æ˜
* ç¼ºç‚¹: **ä¼šä½¿jsåŒ…ä½“å¤§äº›**ã€‚
  

ä¸ºäº†æ–¹ä¾¿åè®®çš„å¯¼å‡ºï¼Œæˆ‘ç”¨è‡ªå·±å¼€å‘çš„ä¸€ä¸ªprotobufå·¥å…·:[egf-protobuf](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/egf-protobuf-cli#readme)

1. å®‰è£…å·¥å…·åˆ°å…¨å±€æˆ–è€…é¡¹ç›®ç›®å½•
    ```bash
    npm install egf-protobuf -g
    æˆ–è€…
    npm install -S egf-protobuf
    ```
    
2. åœ¨package.jsonå†™ä¸€ä¸‹npm script
    ```json
    "scripts": {
        "genPb": "egf-pb g",
        "pbInit": "egf-pb i"
    }
    ```
    
3. åˆå§‹åŒ–é¡¹ç›® npm run pbInit

4. åˆ›å»ºprotoæ–‡ä»¶ç›®å½•protofiles

5. å†™åè®® pb_base.proto
   ```proto
   package pb_test;
   message User {
       required uint32 uid = 1;
       required string name = 2;
   }
    //ç™»å½•è¯·æ±‚
   message Cs_Login {
       required string name = 1;
   }
   //ç™»å½•è¿”å›
   message Sc_Login {
       required uint32 uid = 1;
       repeated User users = 2;
   }
   
    //ç”¨æˆ·è¿›æ¥æ¨é€
   message Sc_userEnter {
       required User user = 1;
   
   }
    //ç”¨æˆ·ç¦»å¼€æ¨é€
   message Sc_userLeave {
       required uint32 uid = 2;
   }
   //æ¶ˆæ¯ç»“æ„
    message ChatMsg {
       required uint32 uid = 1;
       required string msg = 2;
   }
   //å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
   message Cs_SendMsg {
       required ChatMsg msg = 1;
   }
   //æœåŠ¡å™¨æ¨é€æ¶ˆæ¯
   message Sc_Msg {
       required ChatMsg msg =1;
   }
   ```
   
6. ä¿®æ”¹ä¸€ä¸‹å¯¼å‡ºé…ç½®protobuf/epbconfig.js
    ```js
        /**.proto æ–‡ä»¶å¤¹è·¯å¾„  */
        sourceRoot: "protofiles",//æŒ‡å‘åˆ›å»ºçš„protoæ–‡ä»¶ç›®å½•
        /**è¾“å‡ºjsæ–‡ä»¶å */
        outFileName: "proto_bundle",
        /**ç”Ÿæˆjsçš„è¾“å‡ºè·¯å¾„ */
        outputDir: "egf-ccc-net-ws/assets/protojs",//å®¢æˆ·ç«¯jsæ–‡ä»¶è¾“å‡ºç›®å½•
        /**å£°æ˜æ–‡ä»¶è¾“å‡ºè·¯å¾„ */
        dtsOutDir:  "egf-ccc-net-ws/libs",//å®¢æˆ·ç«¯å£°æ˜æ–‡ä»¶è¾“å‡ºç›®å½•

    ```
    **ps**:ç”±äºåç«¯ç”¨tsï¼Œæ‰€ä»¥ä¹Ÿé…ç½®äº†åç«¯æ–‡ä»¶å¯¼å‡ºè·¯å¾„(å‰åç«¯åŒæ—¶å¯¼å‡º=åŒå€çš„å¿«ä¹ğŸ¤ğŸ»âœŒğŸ»)
    
    ```js
	/**æœåŠ¡ç«¯è¾“å‡ºé…ç½® */
	serverOutputConfig: {
		/**protobufjsåº“è¾“å‡ºç›®å½• */
    	pbjsLibDir: "egf-net-ws-server/libs",
	    /**ç”Ÿæˆçš„proto jsæ–‡ä»¶è¾“å‡º */
    	pbjsOutDir: "egf-net-ws-server/protojs",
	    /**å£°æ˜æ–‡ä»¶è¾“å‡ºè·¯å¾„ */
	dtsOutDir: "egf-net-ws-server/libs"
	
    }
    ```
    
7. å¯¼å‡ºjså’Œ.d.ts
    ```bash
    npm run genPb
    ```
    
8. é¡¹ç›®ä¸­å¼•å…¥protobufjsåº“å’Œproto_bundle.js
   1. CocosCreatoréœ€è¦å°†å®ƒä»¬è®¾ç½®ä¸ºæ’ä»¶
   2. nodejsé¡¹ç›®ï¼Œéœ€è¦ä½¿ç”¨requireåŠ è½½å®ƒä»¬
    ```ts
    require("../libs/protobuf.js");
    require("../protojs/proto_bundle.js");
    ```
è¿™æ ·å°±å¯ä»¥åœ¨ä¸šåŠ¡é‡Œæ„‰å¿«åœ°ä½¿ç”¨protobufæ¥è¿›è¡Œåè®®çš„ç¼–ç è§£ç äº†
   
   ```ts
   //ç¼–ç 
   const uint8arr = pb_test.ChatMsg.encode({ msg: "hello world", uid: 1 }).finish();
   //è§£ç 
   const msg: pb_test.IChatMsg = pb_test.ChatMsg.decode(uint8arr);
   //ç»“æœ: { msg: "hello world", uid: 1 }
   ```
   
   
### å°†enetå’Œprotobufç»“åˆèµ·æ¥

enetä¸­å¦‚æœéœ€è¦è‡ªå®šä¹‰åè®®å¤„ç†åˆ™éœ€è¦å®ç°enet.IProtoHandleræ¥å£

```ts
interface IProtoHandler<ProtoKeyType = any> {
    /**
     * åè®®keyè½¬å­—ç¬¦ä¸²key
     * @param protoKey
     */
    protoKey2Key(protoKey: ProtoKeyType): string;
    /**
     * ç¼–ç æ•°æ®åŒ…
     * @param pkg
     * @param useCrypto æ˜¯å¦åŠ å¯†
     */
    encodePkg<T>(pkg: enet.IPackage<T>, useCrypto?: boolean): NetData;
    /**
     * ç¼–ç æ¶ˆæ¯æ•°æ®åŒ…
     * @param msg æ¶ˆæ¯åŒ…
     * @param useCrypto æ˜¯å¦åŠ å¯†
     */
    encodeMsg<T>(msg: enet.IMessage<T, ProtoKeyType>, useCrypto?: boolean): NetData;
    /**
     * è§£ç ç½‘ç»œæ•°æ®åŒ…ï¼Œ
     * @param data
     */
    decodePkg<T>(data: NetData): IDecodePackage<T>;
    /**
     * å¿ƒè·³é…ç½®
     */
    heartbeatConfig: enet.IHeartBeatConfig;
}
```

**ä¸¾ä¸ªæ —å­**ğŸŒ°

æˆ‘éœ€è¦ä½¿ç”¨protobufåè®®è¿›è¡Œé€šä¿¡

é‚£æˆ‘å°±å®ç°æ¥å£å†™ä¸€ä¸ªprotobufåè®®å¤„ç†å™¨ã€‚

æ¯”å¦‚:[egf-pbws](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/enet-pbws#readme)

**ç®€å•ä¸¤æ­¥ç”¨èµ·æ¥**(â˜ï¾Ÿãƒ®ï¾Ÿ)â˜

1. å®‰è£…egf-pbws
   

   ```bash
   npm i egf-pbws
   ```
2. å’Œenetç»“åˆ
   ```ts
   import { NetNode } from "@ailhc/enet";
   import { PbProtoHandler } from "@ailhc/enet-pbws";  
   const netMgr = new NetNode<string>();
   this._net = netMgr;
   //å°†åè®®ç¼–è§£ç å¯¹è±¡æ³¨å…¥ æˆ‘è¿™é‡Œæ˜¯pb_test
   const protoHandler = new PbProtoHandler(pb_test);
   netMgr.init({
        netEventHandler: this,
        protoHandler: protoHandler
    })
   ```

å‡†å¤‡å·¥ä½œåšå¥½äº†ï¼Œå¼€å§‹å†™å®¢æˆ·ç«¯

### CocosCreator2.4.2å®ç°å¤šäººèŠå¤©å®¢æˆ·ç«¯

è¿™ä¸ªå®¢æˆ·ç«¯é¡¹ç›®ä¸­å†™äº†3ä¸ªä¾‹å­
1. testcases/websocket-test çº¯ä½¿ç”¨websocket+æ§åˆ¶å°æ‰“å°çš„æ–¹å¼çš„ä¾‹å­
2. testcases/simple-test enetç®€å•ä½¿ç”¨ç‰ˆæœ¬ï¼Œæ²¡å¯¹åè®®å±‚è¿›è¡Œå®šåˆ¶
3. testcases/protobuf-test protobufåè®®å®šåˆ¶ç‰ˆ(ä»Šå¤©çš„ä¸»è§’)

ç”±äºç¯‡å¹…æœ‰é™ï¼ŒUIç»„ä»¶çš„å®ç°å°±ä¸è®²äº†ï¼Œéƒ½æ˜¯å¾ˆç®€å•çš„å®ç°ï¼Œå…·ä½“å¯ä»¥ç›´æ¥çœ‹æºç 

ä¼ é€é—¨:[èŠå¤©å®¢æˆ·ç«¯å®ç°](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/examples/egf-net-ws/egf-ccc-net-ws)

**æ ¸å¿ƒé€»è¾‘å®ç°**

```ts
const { ccclass, property } = cc._decorator;
import { NetNode } from "@ailhc/enet";
import { PbProtoHandler } from "@ailhc/enet-pbws";
import MsgPanel from "../../comps/msgPanel/MsgPanel";
@ccclass
export default class ProtobufNetTest extends cc.Component implements enet.INetEventHandler {
    //çœç•¥

    private _uid: number;
    userMap: { [key: number]: string } = {};
    private _userName: string;

    onLoad() {
        const netMgr = new NetNode<string>();
        this._net = netMgr;
        const protoHandler = new PbProtoHandler(pb_test);
        netMgr.init({
            netEventHandler: this,
            protoHandler: protoHandler
        })
        //ç›‘å¬æ¶ˆæ¯æ¨é€
        netMgr.onPush<pb_test.ISc_Msg>("Sc_Msg", { method: this.onMsgPush, context: this });
        //ç›‘å¬ç”¨æˆ·è¿›æ¥
        netMgr.onPush<pb_test.ISc_userEnter>("Sc_userEnter", { method: this.onUserEnter, context: this });
        //ç›‘å¬ç”¨æˆ·ç¦»å¼€
        netMgr.onPush<pb_test.ISc_userLeave>("Sc_userLeave", { method: this.onUserLeave, context: this });

    }
    /**
     * è¿æ¥æœåŠ¡å™¨
     */
    connectSvr() {
        this._net.connect("ws://localhost:8181");
    }
    /**
     * ç™»å½•æœåŠ¡å™¨
     */
    loginSvr() {
        let nameStr = this.nameInputEdit.string;
        if (!nameStr || !nameStr.length) {
            nameStr = "User";
        }
        this._net.request<pb_test.ICs_Login, pb_test.ISc_Login>("Cs_Login", { name: nameStr }, (dpkg) => {
            if (!dpkg.errorMsg) {
                this._userName = nameStr;
                this._uid = dpkg.data.uid;
                const users = dpkg.data.users;
                if (users && users.length) {
                    for (let i = 0; i < users.length; i++) {
                        const user = users[i];
                        this.userMap[user.uid] = user.name;
                    }
                }
                this.hideLoginPanel();
                this.showChatPanel();
            }
        })
    }
    /**
     * å‘é€æ¶ˆæ¯
     */
    sendMsg() {
        const msg = this.msgInputEdit.string;
        if (!msg) {
            console.error(`è¯·è¾“å…¥æ¶ˆæ¯æ–‡æœ¬`)
            return;
        }
        this.msgInputEdit.string = "";
        this._net.notify<pb_test.ICs_SendMsg>("Cs_SendMsg", { msg: { uid: this._uid, msg: msg } })
    }
    //ç”¨æˆ·è¿›æ¥å¤„ç†
    onUserEnter(dpkg: enet.IDecodePackage<pb_test.ISc_userEnter>) {
        if (!dpkg.errorMsg) {
            const enterUser = dpkg.data.user;
            this.userMap[enterUser.uid] = enterUser.name;
            this.msgPanelComp.addMsg({ name: "ç³»ç»Ÿ", msg: `[${enterUser.name}]è¿›æ¥äº†` });
        } else {
            console.error(dpkg.errorMsg);
        }
    }
    //ç”¨æˆ·ç¦»å¼€å¤„ç†
    onUserLeave(dpkg: enet.IDecodePackage<pb_test.ISc_userLeave>) {
        if (!dpkg.errorMsg) {
            if (this.userMap[dpkg.data.uid]) {
                const leaveUserName = this.userMap[dpkg.data.uid];
                this.msgPanelComp.addMsg({ name: "ç³»ç»Ÿ", msg: `[${leaveUserName}]ç¦»å¼€äº†` });
                delete this.userMap[dpkg.data.uid];
            }


        } else {
            console.error(dpkg.errorMsg);
        }
    }
    //æ¶ˆæ¯ä¸‹å‘å¤„ç†
    onMsgPush(dpkg: enet.IDecodePackage<pb_test.ISc_Msg>) {
        if (!dpkg.errorMsg) {
            const svrMsg = dpkg.data.msg;
            let userName: string;
            let isSelf: boolean;
            if (this._uid === svrMsg.uid) {
                userName = "æˆ‘";
                isSelf = true;
            } else if (this.userMap[svrMsg.uid]) {
                userName = this.userMap[svrMsg.uid];
            } else {
                console.error(`æ²¡æœ‰è¿™ä¸ªç”¨æˆ·:${svrMsg.uid}`)

            }
            if (userName) {
                const msgData = { name: userName, msg: svrMsg.msg }
                //åˆ¤æ–­æ˜¯å¦æ”¾çƒŸèŠ±
                this.checkAndFire(svrMsg.msg, isSelf);
                this.msgPanelComp.addMsg(msgData);
            }
        } else {
            console.error(dpkg.errorMsg);
        }
    }


    //#region é®ç½©æç¤ºé¢æ¿
    public showMaskPanel() {
        if (!this.maskPanel.active) this.maskPanel.active = true;
        if (!isNaN(this._hideMaskTimeId)) {
            clearTimeout(this._hideMaskTimeId);
        }
    }
    public updateMaskPanelTips(tips: string) {
        this.maskTips.string = tips;
    }
    private _hideMaskTimeId: number;
    public hideMaskPanel() {
        this._hideMaskTimeId = setTimeout(() => {
            this.maskPanel.active = false;
        }, 1000) as any;
    }
    //#endregion

    //#region è¿æ¥é¢æ¿
    showConnectPanel() {
        this.connectPanel.active = true;
    }
    hideConnectPanel() {
        this.connectPanel.active = false;
    }
    //#endregion

    //#region ç™»å½•é¢æ¿
    showLoginPanel() {
        this.loginPanel.active = true;
    }
    hideLoginPanel() {
        this.loginPanel.active = false;
    }
    //#endregion

    //#region èŠå¤©é¢æ¿
    showChatPanel() {
        this.chatPanel.active = true;
    }
    hideChatPanel() {
        this.chatPanel.active = false;
    }
    //#endregion

    onStartConnenct?(connectOpt: enet.IConnectOptions<any>): void {
        this.showMaskPanel()
        this.updateMaskPanelTips("è¿æ¥æœåŠ¡å™¨ä¸­");
    }
    onConnectEnd?(connectOpt: enet.IConnectOptions<any>): void {
        this.updateMaskPanelTips("è¿æ¥æœåŠ¡å™¨æˆåŠŸ");
        this.hideMaskPanel();
        this.showLoginPanel();


    }
    //åˆ¤æ–­å¹¶æ”¾çƒŸèŠ±
    checkAndFire(msg: string, left: boolean) {
        if (msg.includes("çƒŸèŠ±") || msg.includes("ğŸ‡")) {
            window.fire(window.innerWidth * 1 / 2 + (left ? -100 : 100), window.innerHeight / 2);
        }
    }
    //çœç•¥ã€‚ã€‚ã€‚    
}
```
**çƒŸèŠ±æ•ˆæœä»£ç å®ç°**

```js
//çƒŸèŠ±ä»£ç ,ç¨å¾®ä¿®æ”¹ä¸€ä¸‹
(function () {
    var cdom = document.createElement("canvas");
    cdom.id = "myCanvas"; cdom.style.position = "fixed"; cdom.style.left = "0"; cdom.style.top = "0";
    cdom.style.zIndex = 1; document.body.appendChild(cdom); var canvas = document.getElementById('myCanvas'); var context = canvas.getContext('2d');
    cdom.style.background = "rgba(255,255,255,0)"//èƒŒæ™¯é€æ˜
    cdom.style.pointerEvents = "none";//è®©è¿™ä¸ªcanvasçš„ç‚¹å‡»ç©¿é€
    function resizeCanvas() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas, false); resizeCanvas(); clearCanvas();
    function clearCanvas() {
        // context.fillStyle = '#000000';
        // context.fillRect(0, 0, canvas.width, canvas.height);
    }
    var rid;
    window.fire = function fire(x, y) {
        createFireworks(x, y); function tick() { context.globalCompositeOperation = 'destination-out'; context.fillStyle = 'rgba(0,0,0,' + 10 / 100 + ')'; context.fillRect(0, 0, canvas.width, canvas.height); context.globalCompositeOperation = 'lighter'; drawFireworks(); rid = requestAnimationFrame(tick); } cancelAnimationFrame(rid); tick();
    }
    var particles = [];
    function createFireworks(sx, sy) {
        particles = []; var hue = Math.floor(Math.random() * 51) + 150; var hueVariance = 30; var count = 100; for (var i = 0; i < count; i++) { var p = {}; var angle = Math.floor(Math.random() * 360); p.radians = angle * Math.PI / 180; p.x = sx; p.y = sy; p.speed = (Math.random() * 5) + .4; p.radius = p.speed; p.size = Math.floor(Math.random() * 3) + 1; p.hue = Math.floor(Math.random() * ((hue + hueVariance) - (hue - hueVariance))) + (hue - hueVariance); p.brightness = Math.floor(Math.random() * 31) + 50; p.alpha = (Math.floor(Math.random() * 61) + 40) / 100; particles.push(p); }
    }
    function drawFireworks() {
        clearCanvas(); for (var i = 0; i < particles.length; i++) {
            var p = particles[i]; var vx = Math.cos(p.radians) * p.radius; var vy = Math.sin(p.radians) * p.radius + 0.4; p.x += vx; p.y += vy; p.radius *= 1 - p.speed / 100; p.alpha -= 0.005; context.beginPath(); context.arc(p.x, p.y, p.size, 0, Math.PI * 2, false); context.closePath();
            context.fillStyle = 'hsla(' + p.hue + ', 100%, ' + p.brightness + '%, ' + p.alpha + ')'; context.fill();
        }
    }
    // document.addEventListener('mousedown', mouseDownHandler, false);
})();
```
ç•Œé¢æ•ˆæœå›¾

<img src="https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/chatdemotest1.gif" style="zoom: 67%;" />




### node+TypeScriptå®ç°ç®€æ˜“åç«¯

æˆ‘æœ€ç†Ÿæ‚‰nodeï¼Œè€Œä¸”å¯ä»¥å…±ç”¨**enet-pbws**çš„è¿™ä¸ªprotobufåè®®å¤„ç†åº“

å°±å‡ è¡Œä»£ç 

```ts

import WebSocket = require("ws")
import config from "./config";
import { PackageType, PbProtoHandler } from "@ailhc/enet-pbws";
//å¼•å…¥protobufåº“
require("../libs/protobuf.js");
//å¼•å…¥è½¬è¯‘åçš„protojsæ–‡ä»¶
require("../protojs/proto_bundle.js");
import { } from "@ailhc/enet"
export class App {
    private _svr: WebSocket.Server;
    private _clientMap: Map<number, ClientAgent>;
    private _uid: number = 1;
    public protoHandler: PbProtoHandler;
    constructor() {
        this.protoHandler = new PbProtoHandler(global.pb_test)
        const wsvr = new WebSocket.Server({ port: config.port });
        this._svr = wsvr;
        this._clientMap = new Map();
        wsvr.on('connection', (clientWs) => {
            console.log('client connected');
            this._clientMap.set(this._uid, new ClientAgent(this, this._uid, clientWs));
            this._uid++;

        });
        wsvr.on("close", () => {

        });
        console.log(`æœåŠ¡å™¨å¯åŠ¨:ç›‘å¬ç«¯å£:${config.port}`);

    }
    sendToAllClient(data: enet.NetData) {
        this._clientMap.forEach((client) => {
            client.ws.send(data);

        })
    }
    sendToOhterClient(uid: number, data: enet.NetData) {
        this._clientMap.forEach((client) => {
            if (client.uid !== uid) {
                client.ws.send(data);
            }

        })
    }
    sendToClient(uid: number, data: enet.NetData) {
        const client = this._clientMap.get(uid);
        client.ws.send(data);
    }
    onUserLogin(user: pb_test.IUser, reqId: number) {
        const users: pb_test.IUser[] = [];
        const encodeData = this.protoHandler.encodeMsg<pb_test.Sc_Login>({ key: "Sc_Login", data: { uid: user.uid, users: users }, reqId: reqId });
        this.sendToClient(user.uid, encodeData);
        const enterEncodeData = this.protoHandler.encodeMsg<pb_test.Sc_userEnter>({ key: "Sc_userEnter", data: { user: user } })
        this.sendToOhterClient(user.uid, enterEncodeData);
    }
}
//å®¢æˆ·ç«¯ä»£ç†
export class ClientAgent {
    private loginData: pb_test.ICs_Login;
    constructor(public app: App, public uid: number, public ws: WebSocket) {

        ws.on('message', this.onMessage.bind(this));
        ws.on("close", this.onClose.bind(this));
        ws.on("error", this.onError.bind(this));

    }
    public get user(): pb_test.IUser {
        return { uid: this.uid, name: this.loginData.name };
    }
    private onMessage(message) {
        if (typeof message === "string") {
            //TODO å­—ç¬¦ä¸²å¤„ç†


        } else {
            //protobufå¤„ç†
            const dpkg = this.app.protoHandler.decodePkg(message);
            if (dpkg.errorMsg) {
                console.error(`è§£æå®¢æˆ·ç«¯uid:${this.uid}æ¶ˆæ¯é”™è¯¯:`, dpkg.errorMsg);
                return;
            }
            if (dpkg.type === PackageType.DATA) {

                this[dpkg.key] && this[dpkg.key](dpkg)
            }

        }
    }
    private Cs_Login(dpkg: enet.IDecodePackage<pb_test.Cs_Login>) {
        this.loginData = dpkg.data;
        this.app.onUserLogin(this.user, dpkg.reqId);
    }
    private Cs_SendMsg(dpkg: enet.IDecodePackage<pb_test.Cs_SendMsg>) {
        const encodeData = this.app.protoHandler.encodeMsg<pb_test.Sc_Msg>({ key: "Sc_Msg", data: dpkg.data });
        this.app.sendToAllClient(encodeData);
    }
    private onError(err: Error) {
        console.error(err);
    }
    private onClose(code: number, reason: string) {
        console.error(`${this.uid} æ–­å¼€è¿æ¥:code${code},reason:${reason}`);
        const leaveEncodeData = this.app.protoHandler.encodeMsg<pb_test.Sc_userLeave>({ key: "Sc_userLeave", data: { uid: this.uid } })
        this.app.sendToOhterClient(this.uid, leaveEncodeData);
    }

}



(new App())
```

### å¼€å¯å¤šäºº~~Sport~~èŠå¤©

**å¯åŠ¨é¡¹ç›®**

* åˆå§‹åŒ–é¡¹ç›®

  åœ¨/examples/egf-net-wsç›®å½•ï¼Œæ‰“å¼€ç»ˆç«¯

  ```bash
  npm install 
  ```

  å¦‚æœæœ‰yarnåˆ™å¯ä»¥

  ```bash
  yarn install
  ```

* å¯åŠ¨æœåŠ¡å™¨(è¿˜æ˜¯åœ¨åˆšåˆšçš„ç›®å½•ä¸‹)

  ```bash
  npm run star-svr æˆ–è€… npm run dev_svr
  ```

  æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ:

  ```js
  æœåŠ¡å™¨å¯åŠ¨:ç›‘å¬ç«¯å£:8181
  ```

* å¯åŠ¨å®¢æˆ·ç«¯:ç”¨CocosCreator2.4.2æ‰“å¼€é¡¹ç›®

**æœ€ç»ˆæ•ˆæœ**

![](https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/chatdemotest2.gif)

**ä¸€èµ·èŠå¤©æ”¾çƒŸèŠ±**

<img src="https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/chatdemotest3.gif" style="zoom: 67%;" />

## æ€»ç»“

* ç¬¬ä¸€ä¸ªdemoï¼Œå€ŸåŠ©**enet**é€šè¿‡ç®€å•çš„å‡ å¥ä»£ç å°±å¯ä»¥å®ç°socketæ”¶å‘æ¶ˆæ¯

* ç¬¬äºŒä¸ªdemoï¼Œå€ŸåŠ©**enet**ä»¥åŠ**egf-protobuf**å’Œ**enet-pbws**å¯è½»æ¾å®ç°åŸºäºprotobufåè®®çš„å¤šäººèŠå¤©å®¤åº”ç”¨

ç”±äºç¯‡å¹…æœ‰é™ï¼Œæœ‰äº›åŠŸèƒ½æ²¡æœ‰è®²åˆ°
* è‡ªå®šä¹‰æ¡æ‰‹å¤„ç†
* è‡ªå®šä¹‰socketå±‚
* è‡ªå®šä¹‰ç½‘ç»œåé¦ˆå±‚(æ¯”å¦‚ï¼šå‘é€è¯·æ±‚å°±å¼¹å‡ºè¯·æ±‚ä¸­é®ç½©ï¼Œè¯·æ±‚ç»“æŸè‡ªåŠ¨å…³é—­é®ç½©ç­‰)
* å¿ƒè·³å¤„ç†
* é‡è¿å¤„ç†

åç»­å°†åˆ†äº«ä¸€ä¸‹ï¼Œå¦‚ä½•è®¾è®¡**enet**
## æœ€å

æˆ‘æ˜¯å–œæ¬¢**æ¸¸æˆå¼€å‘**çš„æµ·æ½®ğŸ˜‰

æŒç»­å­¦ä¹ ï¼ŒæŒç»­upï¼Œ**åˆ†äº«**æ¸¸æˆå¼€å‘å¿ƒå¾—ï¼Œç©è½¬æ¸¸æˆå¼€å‘

**æ¸¸æˆå¼€å‘ä¹‹è·¯æœ‰è¶£ä½†ä¸æ˜“,**

**ç©èµ·æ¥æ‰èƒ½ä¸€ç›´çƒ­æƒ…æ´‹æº¢ã€‚**

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œæ›´å¤šå†…å®¹æŒç»­æ›´æ–°



å…¬ä¼—å·æœç´¢:ç©è½¬æ¸¸æˆå¼€å‘



æˆ–æ‰«ç :<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abd0c14c9c954e56af20adb71fa00da9~tplv-k3u1fbpfcp-zoom-1.image" alt="img" style="zoom:50%;" />

QQ ç¾¤: 1103157878

åšå®¢ä¸»é¡µ: https://ailhc.github.io/

æ˜é‡‘: https://juejin.cn/user/3069492195769469

github: https://github.com/AILHC









