---
title: 一步两步三步:仿微信聊天放烟花
categories:
  - EasyGameFramework
  - 想法流水
tags:
  - EasyGameFramework
  - Discussion
  - enet
comments: false
date: 2021-01-17 21:29:02
img:
---
## 打个招呼

大家好~

**游戏开发之路有趣但不易,**

**玩起来才能一直热情洋溢。**

我是爱玩的海潮，网名AILHC。

公众号:玩转游戏开发

## 前言


最近微信更新了8.0版本，可以在聊天的时候放炸弹，烟花等动态表情。很多人都玩得不亦乐乎~

在这之前呢，我的框架更新了一个独立的网络模块，可以用于构建长连接网络游戏/应用。

它的特性如下:
1. 跨平台:适用于任意ts/js项目
2. 灵活、高可扩展:可以根据项目需要进行多层次定制
3. 零依赖
4. 强类型:基于TypeScript
5. 功能强大:提供完整的基本实现:握手、心跳、重连
6. 可靠:完善的单元测试

详细的可以点击传送门去了解:[enet](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/enet#readme)

那接下来，我带大家借助enet库实现一个简单的微信聊天附带放烟花的效果

一步两步三步，简单的步骤

玩起来~

## 第一步:引入网络库并初始化

enet这个库，发布于npm公共仓库中。提供多种规范，适用于任何平台。

这次我们直接通过url引入iife格式的js

1. 创建html文件,引入enet库
```html

<!DOCTYPE html>
<html>

<div id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/@ailhc/enet@1.0.0/dist/iife/lib/index.js"></script>

</body>

</html>

```
2. 初始化enet

```html
<script>
    var netNode = new enet.NetNode();
    //定制网络事件反馈逻辑
    netNode.init({
        netEventHandler: {
            //开始连接事件
            onStartConnenct: () => {
                console.log(`开始连接服务器`);
            },
            //连接成功事件
            onConnectEnd: () => {
                console.log(`连接服务器成功👌`);
            }
        }
    });
    
</script>
```
## 第二步: 写上收发消息的逻辑
就几句代码，so easy~
```html
<script>
    //省略初始化逻辑..
    //连上一个公用的websocket测试服务器,它会原本不动的返回发出的消息
    netNode.connect("wss://echo.websocket.org/");

    window.netNode = netNode;
    //封装发送消息逻辑，相当于微信发送按钮
    window.sendMsgToServer = function (msg) {
        if (!netNode.socket.isConnected) {
            console.warn(`服务器还没连上`);
            return;
        }
        netNode.notify("msg", msg);
    }
    //监听服务器消息返回
    netNode.onPush("msg", function (dpkg) {
        console.log(`服务器返回:`, dpkg.data);
    })
    
</script>
```
这个时候，我们就可以运行看看效果了
等待服务器连接成功（因为那个公用的测试服务器有时慢有时快）

在控制台输入 sendMsgToServer("hello enet")

![img](https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/html-enet-test1.gif)

## 第三步:加上烟花效果

烟花效果网上扒来的
[快过年了，用JS让你的网页放烟花吧](https://blog.csdn.net/weixin_42686892/article/details/112589511)

在原来的代码里改
```html
<script>
  //省略
  window.sendMsgToServer = function (msg) {
        if (!netNode.socket.isConnected) {
            console.warn(`服务器还没连上`);
            return;
        }
        netNode.notify("msg", msg);
        checkAndFire(msg);
    }
    netNode.onPush("msg", function (dpkg) {
        console.log(`服务器返回:`, dpkg.data);
        checkAndFire(dpkg.data);
    })

    function checkAndFire(msg) {
        if (msg.includes("烟花") | msg.includes("🎇")) {
            fire(window.innerWidth * 2 / 3, window.innerHeight / 2);
        }
    }
</script>
```
运行起来，看看效果

![img](https://coding-pages-bucket-434147-7588795-4574-367535-1255530080.cos.ap-guangzhou.myqcloud.com/img/html-enet-test2.gif)

简单的仿微信聊天放烟花就这样了
[在线demo](https://ailhc.github.io/demos/enet-simple-demo)

[源码](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/examples/egf-net-ws/egf-simple-net-client)

## 就这？不

虽然看起来使用很简单，但实际功能不简单。

**我使用CocosCreator+TypeScript服务器+protobuf实现了一个使用需求更加复杂的demo**

### 使用protobuf

1. 什么是protobuf
   > protobuf(Google Protocol Buffers)是Google提供一个具有高效的协议数据交换格式工具库(类似Json)，但相比于Json，Protobuf有更高的转化效率，时间效率和空间效率都是JSON的3-5倍。

   > protobuf提供了多种编程语言的支持：C++，JAVA，Python，C#，erlang等
2. 如何使用?

   我这里选择的方案是将proto文件转成js+.d.ts的方式使用。适用于多种环境，就是会使js包体大些。
   
   这里的转换工具，我用自己开发的一个protobuf工具:[egf-protobuf](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/egf-protobuf-cli#readme)

   一个字:强、稳如老狗

   不多说，下次再写文介绍
   1. 安装工具到全局或者项目目录
      ```bash
        npm install egf-protobuf -g
        或者
        npm install -S egf-protobuf
      ```
   2. 在package.json写一下npm script
      ```json
        "scripts": {
          "genPb": "egf-pb g",
          "pbInit": "egf-pb i"
          
        }
      ```
    3. 初始化项目 npm run pbInit
    
    4. 创建proto文件目录protofiles
    5. 写协议 pb_base.proto
    6. 修改protobuf/epbconfig.js中js和声明文件的导出路径，以及proto文件路径
        ```js
            /**.proto 文件夹路径  */
            sourceRoot: "protofiles",
            /**输出js文件名 */
            outFileName: "proto_bundle",
            /**生成js的输出路径 */
            outputDir: "egf-ccc-net-ws/assets/protojs",
            /**声明文件输出路径 */
            dtsOutDir:  "egf-ccc-net-ws/libs",

        ```
    7. 导出proto为js和声明文件
        ```bash
            npm run genPb
        ```
    ps:由于后端用ts，所以配置了后端文件导出路径
### CocosCreator2.4.2实现客户端

这个客户端项目中写了3个例子
1. testcases/websocket-test 纯使用websocket+控制台打印的方式的例子
2. testcases/simple-test enet简单使用版本，没对协议层进行定制
3. testcases/protobuf-test protobuf协议定制版(今天的主角)

由于篇幅有限，UI组件的实现就不讲了，都是很简单的实现，具体可以直接看源码

效果图

**核心实现**

1. 协议层定制

protobuf协议层使用已经实现的库[egf-pbws](https://github.com/AILHC/EasyGameFrameworkOpen/tree/main/packages/enet-pbws#readme)

### 




  




